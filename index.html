<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheet Metal Cutting Planner</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --bg-color: #f5f7fa;
            --text-color: #333;
            --card-bg: white;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --primary-color: #34495e;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #2c3e50;
            --dark-color: #ecf0f1;
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --border-color: #444;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
            position: relative;
        }
        
        .header-controls {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            gap: 15px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px var(--shadow-color);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .card-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        
        tr:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .sheet-info {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .sheet-info input {
            flex: 1;
        }
        
        .canvas-container {
            width: 100%;
            height: 400px;
            border: 1px solid var(--border-color);
            margin-top: 20px;
            overflow: auto;
            background-color: var(--light-color);
        }
        
        canvas {
            display: block;
            margin: 0 auto;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .actions button {
            flex: 1;
        }
        
        .result-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-box {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .hidden {
            display: none;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-container input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: block;
            padding: 10px;
            background: var(--light-color);
            border: 1px dashed var(--secondary-color);
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
        }
        
        .file-input-label:hover {
            background: #dfe6e9;
        }
        
        .dark-mode .file-input-label:hover {
            background: #3d4c5a;
        }
        
        .instructions {
            background-color: #fff9e6;
            border-left: 4px solid #f1c40f;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
        }
        
        .dark-mode .instructions {
            background-color: #3d3a2a;
            border-left-color: #f39c12;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #d35400;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .color-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border: 1px solid #ccc;
        }
        
        /* RTL Support */
        body[dir="rtl"] {
            text-align: right;
        }
        
        body[dir="rtl"] th, 
        body[dir="rtl"] td {
            text-align: right;
        }
        
        body[dir="rtl"] .instructions ul {
            padding-left: 0;
            padding-right: 20px;
        }
        
        body[dir="rtl"] .instructions {
            border-left: none;
            border-right: 4px solid #f1c40f;
        }
        
        body[dir="rtl"] .dark-mode .instructions {
            border-right: 4px solid #f39c12;
        }
        
        body[dir="rtl"] .header-controls {
            right: auto;
            left: 20px;
        }
        
        body[dir="rtl"] .legend-item {
            margin-right: 0;
            margin-left: 10px;
        }
        
        body[dir="rtl"] .legend-color {
            margin-right: 0;
            margin-left: 5px;
        }
    </style>
</head>
<body dir="ltr">
    <div class="container">
        <header>
            <h1 id="app-title">Sheet Metal Cutting Planner</h1>
            <p class="description" id="app-description">Upload cutting data from Excel or enter manually, then generate the optimal cutting plan</p>
            
            <div class="header-controls">
                <button class="control-btn" id="theme-toggle">
                    <span id="theme-icon">ğŸŒ™</span> <span id="theme-text">Dark Mode</span>
                </button>
                <button class="control-btn" id="language-toggle">
                    <span id="language-icon">ğŸŒ</span> <span id="language-text">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
                </button>
            </div>
        </header>
        
        <div class="instructions">
            <h3 id="instructions-title">Usage Instructions:</h3>
            <ul>
                <li id="instruction-1">You can enter cutting data manually or upload from Excel file</li>
                <li id="instruction-2">Excel file should contain these columns: "Name", "Quantity", "Length", "Width", "Thickness"</li>
                <li id="instruction-3">Set the base sheet dimensions before generating the cutting plan</li>
                <li id="instruction-4">You can export the cutting plan as image or save the data</li>
            </ul>
        </div>
        
        <div class="main-content">
            <div class="input-section">
                <div class="card">
                    <h2 class="card-title" id="input-title">Enter Cutting Data</h2>
                    
                    <div class="form-group">
                        <label id="excel-label">Upload from Excel file:</label>
                        <div class="file-input-container">
                            <input type="file" id="excel-file" accept=".xlsx, .xls">
                            <label for="excel-file" class="file-input-label" id="excel-button">Choose Excel File</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label id="manual-label">Or enter data manually:</label>
                        <div class="form-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="part-name" placeholder="Part Name">
                            <input type="number" id="part-quantity" placeholder="Quantity" min="1" value="1">
                        </div>
                        <div class="form-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="part-length" placeholder="Length (mm)" min="1">
                            <input type="number" id="part-width" placeholder="Width (mm)" min="1">
                        </div>
                        <div class="form-row" style="display: flex; gap: 10px;">
                            <input type="number" id="part-thickness" placeholder="Thickness (mm)" min="0.1" step="0.1">
                            <button id="add-part" class="btn-success">Add Part</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-title" id="parts-title">Added Parts</h2>
                    <div class="table-container">
                        <table id="parts-table">
                            <thead>
                                <tr>
                                    <th id="th-name">Name</th>
                                    <th id="th-quantity">Quantity</th>
                                    <th id="th-length">Length</th>
                                    <th id="th-width">Width</th>
                                    <th id="th-thickness">Thickness</th>
                                    <th id="th-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="parts-list">
                                <!-- Will be filled with data -->
                            </tbody>
                        </table>
                    </div>
                    <div class="actions">
                        <button id="clear-parts" class="btn-danger">Clear All</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-title" id="settings-title">Sheet Settings</h2>
                    <div class="sheet-info">
                        <div class="form-group" style="flex: 1;">
                            <label id="sheet-length-label">Sheet Length (mm)</label>
                            <input type="number" id="sheet-length" value="2000" min="100">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label id="sheet-width-label">Sheet Width (mm)</label>
                            <input type="number" id="sheet-width" value="1000" min="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label id="margin-label">Cutting Margin (mm)</label>
                        <input type="number" id="cut-margin" value="5" min="0">
                    </div>
                    <button id="generate-plan">Generate Cutting Plan</button>
                </div>
            </div>
            
            <div class="output-section">
                <div class="card">
                    <h2 class="card-title" id="plan-title">Cutting Plan</h2>
                    <div class="canvas-container">
                        <canvas id="cutting-canvas"></canvas>
                    </div>
                    
                    <div class="color-legend" id="color-legend">
                        <!-- Will be filled with colors -->
                    </div>
                    
                    <div class="result-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="utilization-rate">0%</div>
                            <div class="stat-label" id="utilization-label">Utilization Rate</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="sheets-used">0</div>
                            <div class="stat-label" id="sheets-label">Sheets Used</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="waste-area">0</div>
                            <div class="stat-label" id="waste-label">Waste Area (mmÂ²)</div>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button id="export-image" class="btn-success">Export as Image</button>
                        <button id="export-data">Export Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Application data
        let parts = [];
        let cuttingPlan = [];
        let sheetsUsed = 0;
        let isDarkMode = false;
        let isEnglish = true;
        
        // Translation dictionary
        const translations = {
            en: {
                // App title and description
                'app-title': 'Sheet Metal Cutting Planner',
                'app-description': 'Upload cutting data from Excel or enter manually, then generate the optimal cutting plan',
                
                // Instructions
                'instructions-title': 'Usage Instructions:',
                'instruction-1': 'You can enter cutting data manually or upload from Excel file',
                'instruction-2': 'Excel file should contain these columns: "Name", "Quantity", "Length", "Width", "Thickness"',
                'instruction-3': 'Set the base sheet dimensions before generating the cutting plan',
                'instruction-4': 'You can export the cutting plan as image or save the data',
                
                // Input section
                'input-title': 'Enter Cutting Data',
                'excel-label': 'Upload from Excel file:',
                'excel-button': 'Choose Excel File',
                'manual-label': 'Or enter data manually:',
                
                // Parts list
                'parts-title': 'Added Parts',
                'th-name': 'Name',
                'th-quantity': 'Quantity',
                'th-length': 'Length',
                'th-width': 'Width',
                'th-thickness': 'Thickness',
                'th-actions': 'Actions',
                
                // Sheet settings
                'settings-title': 'Sheet Settings',
                'sheet-length-label': 'Sheet Length (mm)',
                'sheet-width-label': 'Sheet Width (mm)',
                'margin-label': 'Cutting Margin (mm)',
                
                // Output section
                'plan-title': 'Cutting Plan',
                'utilization-label': 'Utilization Rate',
                'sheets-label': 'Sheets Used',
                'waste-label': 'Waste Area (mmÂ²)',
                
                // Buttons
                'add-part': 'Add Part',
                'clear-parts': 'Clear All',
                'generate-plan': 'Generate Cutting Plan',
                'export-image': 'Export as Image',
                'export-data': 'Export Data',
                'delete': 'Delete',
                
                // Placeholders
                'part-name-placeholder': 'Part Name',
                'quantity-placeholder': 'Quantity',
                'length-placeholder': 'Length (mm)',
                'width-placeholder': 'Width (mm)',
                'thickness-placeholder': 'Thickness (mm)',
                
                // Messages
                'no-parts': 'No parts added',
                'confirm-clear': 'Are you sure you want to clear all parts?',
                'alert-fill-all': 'Please fill all fields',
                'alert-sheet-dimensions': 'Please specify sheet dimensions',
                'alert-no-parts': 'Please add parts first',
                'alert-no-plan': 'No cutting plan to export',
                'excel-loaded': 'Parts loaded from Excel file',
                'excel-error': 'Error reading Excel file',
                'excel-no-data': 'No valid data found in Excel file',
                
                // Theme and language
                'dark-mode': 'Dark Mode',
                'light-mode': 'Light Mode',
                'switch-arabic': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                'switch-english': 'English'
            },
            ar: {
                // App title and description
                'app-title': 'Ù†Ø¸Ø§Ù… ØªØ®Ø·ÙŠØ· Ù‚Ø·Ø¹ Ø§Ù„ØµØ§Ø¬',
                'app-description': 'Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ù…Ù„Ù Excel Ø£Ùˆ Ø£Ø¯Ø®Ù„Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§ØŒ Ø«Ù… Ø£Ù†Ø´Ø¦ Ø®Ø·Ø© Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø«Ù„Ù‰',
                
                // Instructions
                'instructions-title': 'ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:',
                'instruction-1': 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù…Ù„Ù Excel',
                'instruction-2': 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ù…Ù„Ù Excel Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: "Ø§Ù„Ø§Ø³Ù…"ØŒ "Ø§Ù„Ø¹Ø¯Ø¯"ØŒ "Ø§Ù„Ø·ÙˆÙ„"ØŒ "Ø§Ù„Ø¹Ø±Ø¶"ØŒ "Ø§Ù„Ø³Ù…Ùƒ"',
                'instruction-3': 'Ø­Ø¯Ø¯ Ø£Ø¨Ø¹Ø§Ø¯ Ù„ÙˆØ­ Ø§Ù„ØµØ§Ø¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ù‚Ø·Ø¹',
                'instruction-4': 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØµØ¯ÙŠØ± Ø®Ø·Ø© Ø§Ù„Ù‚Ø·Ø¹ ÙƒØµÙˆØ±Ø© Ø£Ùˆ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                
                // Input section
                'input-title': 'Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·Ø¹',
                'excel-label': 'ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù…Ù„Ù Excel:',
                'excel-button': 'Ø§Ø®ØªØ± Ù…Ù„Ù Excel',
                'manual-label': 'Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§:',
                
                // Parts list
                'parts-title': 'Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¶Ø§ÙØ©',
                'th-name': 'Ø§Ù„Ø§Ø³Ù…',
                'th-quantity': 'Ø§Ù„Ø¹Ø¯Ø¯',
                'th-length': 'Ø§Ù„Ø·ÙˆÙ„',
                'th-width': 'Ø§Ù„Ø¹Ø±Ø¶',
                'th-thickness': 'Ø§Ù„Ø³Ù…Ùƒ',
                'th-actions': 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
                
                // Sheet settings
                'settings-title': 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ÙˆØ­',
                'sheet-length-label': 'Ø·ÙˆÙ„ Ø§Ù„Ù„ÙˆØ­ (Ù…Ù…)',
                'sheet-width-label': 'Ø¹Ø±Ø¶ Ø§Ù„Ù„ÙˆØ­ (Ù…Ù…)',
                'margin-label': 'Ù‡Ø§Ù…Ø´ Ø§Ù„Ù‚Ø·Ø¹ (Ù…Ù…)',
                
                // Output section
                'plan-title': 'Ø®Ø·Ø© Ø§Ù„Ù‚Ø·Ø¹',
                'utilization-label': 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…',
                'sheets-label': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©',
                'waste-label': 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ù‡Ø¯Ø±Ø© (Ù…Ù…Â²)',
                
                // Buttons
                'add-part': 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø©',
                'clear-parts': 'Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„',
                'generate-plan': 'Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ù‚Ø·Ø¹',
                'export-image': 'ØªØµØ¯ÙŠØ± ÙƒØµÙˆØ±Ø©',
                'export-data': 'ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                'delete': 'Ø­Ø°Ù',
                
                // Placeholders
                'part-name-placeholder': 'Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©',
                'quantity-placeholder': 'Ø§Ù„Ø¹Ø¯Ø¯',
                'length-placeholder': 'Ø§Ù„Ø·ÙˆÙ„ (Ù…Ù…)',
                'width-placeholder': 'Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ù…)',
                'thickness-placeholder': 'Ø§Ù„Ø³Ù…Ùƒ (Ù…Ù…)',
                
                // Messages
                'no-parts': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ Ù…Ø¶Ø§ÙØ©',
                'confirm-clear': 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø¹ØŸ',
                'alert-fill-all': 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„',
                'alert-sheet-dimensions': 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù„ÙˆØ­',
                'alert-no-parts': 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹ Ø£ÙˆÙ„Ø§Ù‹',
                'alert-no-plan': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ù‚Ø·Ø¹ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§',
                'excel-loaded': 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ù…Ù„Ù Excel',
                'excel-error': 'Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel',
                'excel-no-data': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ù…Ù„Ù Excel',
                
                // Theme and language
                'dark-mode': 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ',
                'light-mode': 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ',
                'switch-arabic': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                'switch-english': 'English'
            }
        };
        
        // DOM elements
        const partsList = document.getElementById('parts-list');
        const addPartBtn = document.getElementById('add-part');
        const clearPartsBtn = document.getElementById('clear-parts');
        const generatePlanBtn = document.getElementById('generate-plan');
        const exportImageBtn = document.getElementById('export-image');
        const exportDataBtn = document.getElementById('export-data');
        const excelFileInput = document.getElementById('excel-file');
        const canvas = document.getElementById('cutting-canvas');
        const ctx = canvas.getContext('2d');
        const themeToggle = document.getElementById('theme-toggle');
        const languageToggle = document.getElementById('language-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        const languageText = document.getElementById('language-text');
        
        // Initialize the app
        function initApp() {
            // Add event listeners
            addPartBtn.addEventListener('click', addPart);
            clearPartsBtn.addEventListener('click', clearParts);
            generatePlanBtn.addEventListener('click', generateCuttingPlan);
            exportImageBtn.addEventListener('click', exportAsImage);
            exportDataBtn.addEventListener('click', exportData);
            excelFileInput.addEventListener('change', handleExcelFile);
            themeToggle.addEventListener('click', toggleTheme);
            languageToggle.addEventListener('click', toggleLanguage);
            
            // Update parts list display
            updatePartsList();
            
            // Initialize canvas
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Set initial language and theme
            updateLanguage();
            updateTheme();
        }
        
        // Toggle between light and dark mode
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            updateTheme();
        }
        
        // Update theme based on current state
        function updateTheme() {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                themeIcon.textContent = 'â˜€ï¸';
                themeText.textContent = isEnglish ? translations.en['light-mode'] : translations.ar['light-mode'];
            } else {
                document.body.classList.remove('dark-mode');
                themeIcon.textContent = 'ğŸŒ™';
                themeText.textContent = isEnglish ? translations.en['dark-mode'] : translations.ar['dark-mode'];
            }
        }
        
        // Toggle between English and Arabic
        function toggleLanguage() {
            isEnglish = !isEnglish;
            updateLanguage();
        }
        
        // Update language based on current state
        function updateLanguage() {
            const lang = isEnglish ? 'en' : 'ar';
            const dir = isEnglish ? 'ltr' : 'rtl';
            
            // Update document direction
            document.body.setAttribute('dir', dir);
            document.documentElement.setAttribute('lang', lang);
            
            // Update language toggle text
            languageText.textContent = isEnglish ? translations.en['switch-arabic'] : translations.ar['switch-english'];
            
            // Update all translatable elements
            for (const [key, value] of Object.entries(translations[lang])) {
                const element = document.getElementById(key);
                if (element) {
                    if (element.tagName === 'INPUT' && key.includes('placeholder')) {
                        element.placeholder = value;
                    } else {
                        element.textContent = value;
                    }
                }
            }
            
            // Update parts list
            updatePartsList();
        }
        
        // Add a new part
        function addPart() {
            const name = document.getElementById('part-name').value.trim();
            const quantity = parseInt(document.getElementById('part-quantity').value);
            const length = parseInt(document.getElementById('part-length').value);
            const width = parseInt(document.getElementById('part-width').value);
            const thickness = parseFloat(document.getElementById('part-thickness').value);
            
            if (!name || !quantity || !length || !width || !thickness) {
                alert(isEnglish ? translations.en['alert-fill-all'] : translations.ar['alert-fill-all']);
                return;
            }
            
            parts.push({
                id: Date.now(),
                name,
                quantity,
                length,
                width,
                thickness
            });
            
            // Clear fields
            document.getElementById('part-name').value = '';
            document.getElementById('part-quantity').value = '1';
            document.getElementById('part-length').value = '';
            document.getElementById('part-width').value = '';
            document.getElementById('part-thickness').value = '';
            
            updatePartsList();
        }
        
        // Update parts list display
        function updatePartsList() {
            partsList.innerHTML = '';
            
            if (parts.length === 0) {
                partsList.innerHTML = `<tr><td colspan="6" style="text-align: center;">${isEnglish ? translations.en['no-parts'] : translations.ar['no-parts']}</td></tr>`;
                return;
            }
            
            parts.forEach(part => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${part.name}</td>
                    <td>${part.quantity}</td>
                    <td>${part.length} mm</td>
                    <td>${part.width} mm</td>
                    <td>${part.thickness} mm</td>
                    <td>
                        <button onclick="removePart(${part.id})" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">${isEnglish ? translations.en['delete'] : translations.ar['delete']}</button>
                    </td>
                `;
                partsList.appendChild(row);
            });
        }
        
        // Remove a part
        function removePart(id) {
            parts = parts.filter(part => part.id !== id);
            updatePartsList();
        }
        
        // Clear all parts
        function clearParts() {
            if (confirm(isEnglish ? translations.en['confirm-clear'] : translations.ar['confirm-clear'])) {
                parts = [];
                updatePartsList();
            }
        }
        
        // Handle Excel file upload - CORRECTED VERSION
        function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Assume the first sheet contains the data
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        alert(isEnglish ? translations.en['excel-no-data'] : translations.ar['excel-no-data']);
                        return;
                    }
                    
                    // Convert data to app format
                    const newParts = [];
                    jsonData.forEach((row, index) => {
                        // Normalize column names to handle different naming conventions
                        const normalizedRow = {};
                        Object.keys(row).forEach(key => {
                            const normalizedKey = key.toLowerCase().trim();
                            normalizedRow[normalizedKey] = row[key];
                        });
                        
                        // Try to extract data with flexible column names
                        const name = normalizedRow.name || normalizedRow['Ø§Ù„Ø§Ø³Ù…'] || normalizedRow.part || `Part ${index + 1}`;
                        const quantity = normalizedRow.quantity || normalizedRow['Ø§Ù„Ø¹Ø¯Ø¯'] || normalizedRow.qty || 1;
                        const length = normalizedRow.length || normalizedRow['Ø§Ù„Ø·ÙˆÙ„'] || normalizedRow.l || 0;
                        const width = normalizedRow.width || normalizedRow['Ø§Ù„Ø¹Ø±Ø¶'] || normalizedRow.w || 0;
                        const thickness = normalizedRow.thickness || normalizedRow['Ø§Ù„Ø³Ù…Ùƒ'] || normalizedRow.t || 1;
                        
                        // Validate required data
                        if (length > 0 && width > 0) {
                            newParts.push({
                                id: Date.now() + index,
                                name: name.toString(),
                                quantity: parseInt(quantity) || 1,
                                length: parseInt(length),
                                width: parseInt(width),
                                thickness: parseFloat(thickness) || 1
                            });
                        }
                    });
                    
                    if (newParts.length === 0) {
                        alert(isEnglish ? translations.en['excel-no-data'] : translations.ar['excel-no-data']);
                        return;
                    }
                    
                    // Add new parts to the existing list
                    parts = [...parts, ...newParts];
                    updatePartsList();
                    alert(isEnglish ? translations.en['excel-loaded'] : translations.ar['excel-loaded']);
                    
                    // Reset file input to allow uploading the same file again if needed
                    event.target.value = '';
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    alert(isEnglish ? translations.en['excel-error'] : translations.ar['excel-error']);
                }
            };
            
            reader.onerror = function() {
                alert(isEnglish ? translations.en['excel-error'] : translations.ar['excel-error']);
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Resize canvas
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            // Redraw cutting plan if exists
            if (cuttingPlan.length > 0) {
                drawCuttingPlan();
            }
        }
        
        // Generate cutting plan
        function generateCuttingPlan() {
            if (parts.length === 0) {
                alert(isEnglish ? translations.en['alert-no-parts'] : translations.ar['alert-no-parts']);
                return;
            }
            
            const sheetLength = parseInt(document.getElementById('sheet-length').value);
            const sheetWidth = parseInt(document.getElementById('sheet-width').value);
            const cutMargin = parseInt(document.getElementById('cut-margin').value);
            
            if (!sheetLength || !sheetWidth) {
                alert(isEnglish ? translations.en['alert-sheet-dimensions'] : translations.ar['alert-sheet-dimensions']);
                return;
            }
            
            // Initialize cutting plan
            cuttingPlan = [];
            sheetsUsed = 0;
            
            // Copy parts and expand by quantity
            let allPieces = [];
            parts.forEach(part => {
                for (let i = 0; i < part.quantity; i++) {
                    allPieces.push({
                        id: part.id,
                        name: part.name,
                        length: part.length,
                        width: part.width,
                        thickness: part.thickness
                    });
                }
            });
            
            // Sort pieces from largest to smallest (by area)
            allPieces.sort((a, b) => (b.length * b.width) - (a.length * a.width));
            
            // Simple algorithm for placing pieces (can be improved for efficiency)
            let currentSheet = {
                pieces: [],
                remainingAreas: [{x: 0, y: 0, width: sheetWidth, height: sheetLength}]
            };
            
            sheetsUsed = 1;
            cuttingPlan.push(currentSheet);
            
            allPieces.forEach(piece => {
                let placed = false;
                
                // Try to place the piece in existing sheets
                for (let i = 0; i < cuttingPlan.length && !placed; i++) {
                    const sheet = cuttingPlan[i];
                    
                    // Find suitable area in the sheet
                    for (let j = 0; j < sheet.remainingAreas.length && !placed; j++) {
                        const area = sheet.remainingAreas[j];
                        
                        // Check if piece fits in the area (with or without rotation)
                        if ((piece.width + cutMargin <= area.width && piece.length + cutMargin <= area.height) ||
                            (piece.length + cutMargin <= area.width && piece.width + cutMargin <= area.height)) {
                            
                            // Determine optimal orientation
                            let rotated = false;
                            if (piece.width + cutMargin <= area.width && piece.length + cutMargin <= area.height) {
                                // Normal orientation
                            } else if (piece.length + cutMargin <= area.width && piece.width + cutMargin <= area.height) {
                                // Rotate the piece
                                rotated = true;
                            }
                            
                            const pieceWidth = rotated ? piece.length : piece.width;
                            const pieceLength = rotated ? piece.width : piece.length;
                            
                            // Place the piece
                            sheet.pieces.push({
                                ...piece,
                                x: area.x,
                                y: area.y,
                                rotated,
                                sheetIndex: i
                            });
                            
                            // Update remaining areas (simplified algorithm)
                            sheet.remainingAreas.splice(j, 1);
                            
                            // Add new areas
                            if (area.width - (pieceWidth + cutMargin) > 0) {
                                sheet.remainingAreas.push({
                                    x: area.x + pieceWidth + cutMargin,
                                    y: area.y,
                                    width: area.width - (pieceWidth + cutMargin),
                                    height: area.height
                                });
                            }
                            
                            if (area.height - (pieceLength + cutMargin) > 0) {
                                sheet.remainingAreas.push({
                                    x: area.x,
                                    y: area.y + pieceLength + cutMargin,
                                    width: pieceWidth,
                                    height: area.height - (pieceLength + cutMargin)
                                });
                            }
                            
                            placed = true;
                            break;
                        }
                    }
                }
                
                // If piece couldn't be placed in any existing sheet, create a new one
                if (!placed) {
                    const newSheet = {
                        pieces: [],
                        remainingAreas: [{x: 0, y: 0, width: sheetWidth, height: sheetLength}]
                    };
                    
                    // Place piece in the new sheet
                    newSheet.pieces.push({
                        ...piece,
                        x: 0,
                        y: 0,
                        rotated: false,
                        sheetIndex: cuttingPlan.length
                    });
                    
                    // Update remaining areas
                    newSheet.remainingAreas = [
                        {x: piece.width + cutMargin, y: 0, width: sheetWidth - (piece.width + cutMargin), height: sheetLength},
                        {x: 0, y: piece.length + cutMargin, width: piece.width, height: sheetLength - (piece.length + cutMargin)}
                    ];
                    
                    cuttingPlan.push(newSheet);
                    sheetsUsed++;
                }
            });
            
            // Draw cutting plan
            drawCuttingPlan();
            
            // Update statistics
            updateStatistics();
        }
        
        // Draw cutting plan
        function drawCuttingPlan() {
            const sheetLength = parseInt(document.getElementById('sheet-length').value);
            const sheetWidth = parseInt(document.getElementById('sheet-width').value);
            const scale = Math.min(
                canvas.width / (sheetWidth + 40),
                canvas.height / (sheetLength + 40)
            );
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw sheets and pieces
            const colors = [
                '#3498db', '#e74c3c', '#2ecc71', '#f39c12', 
                '#9b59b6', '#1abc9c', '#d35400', '#c0392b'
            ];
            
            // Create color legend
            const colorLegend = document.getElementById('color-legend');
            colorLegend.innerHTML = '';
            
            const partTypes = [...new Set(parts.map(p => p.name))];
            partTypes.forEach((type, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${colors[index % colors.length]}"></div>
                    <span>${type}</span>
                `;
                colorLegend.appendChild(legendItem);
            });
            
            // Draw each sheet
            cuttingPlan.forEach((sheet, sheetIndex) => {
                const xOffset = (canvas.width - (sheetWidth * scale)) / 2;
                const yOffset = 20 + (sheetIndex * (sheetLength * scale + 40));
                
                // Draw sheet border
                ctx.strokeStyle = '#34495e';
                ctx.lineWidth = 2;
                ctx.strokeRect(xOffset, yOffset, sheetWidth * scale, sheetLength * scale);
                
                // Write sheet number
                ctx.fillStyle = '#34495e';
                ctx.font = '14px Arial';
                ctx.fillText(`Sheet ${sheetIndex + 1}`, xOffset, yOffset - 5);
                
                // Draw pieces in the sheet
                sheet.pieces.forEach(piece => {
                    const colorIndex = partTypes.indexOf(piece.name);
                    const color = colors[colorIndex % colors.length];
                    
                    const x = xOffset + piece.x * scale;
                    const y = yOffset + piece.y * scale;
                    const width = (piece.rotated ? piece.length : piece.width) * scale;
                    const height = (piece.rotated ? piece.width : piece.length) * scale;
                    
                    // Draw the piece
                    ctx.fillStyle = color + '80'; // Transparency
                    ctx.fillRect(x, y, width, height);
                    
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, width, height);
                    
                    // Write piece name and dimensions
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    
                    const textX = x + width / 2;
                    const textY = y + height / 2;
                    
                    ctx.fillText(piece.name, textX, textY - 10);
                    ctx.fillText(
                        `${piece.rotated ? piece.length : piece.width} Ã— ${piece.rotated ? piece.width : piece.length}`,
                        textX, textY + 5
                    );
                    
                    // Draw rotation symbol if piece is rotated
                    if (piece.rotated) {
                        ctx.fillStyle = '#e74c3c';
                        ctx.font = '8px Arial';
                        ctx.fillText('â†»', x + 10, y + 10);
                    }
                });
            });
        }
        
        // Update statistics
        function updateStatistics() {
            const sheetLength = parseInt(document.getElementById('sheet-length').value);
            const sheetWidth = parseInt(document.getElementById('sheet-width').value);
            const totalSheetArea = sheetLength * sheetWidth * sheetsUsed;
            
            let usedArea = 0;
            parts.forEach(part => {
                usedArea += (part.length * part.width) * part.quantity;
            });
            
            const utilizationRate = Math.round((usedArea / totalSheetArea) * 100);
            const wasteArea = totalSheetArea - usedArea;
            
            document.getElementById('utilization-rate').textContent = `${utilizationRate}%`;
            document.getElementById('sheets-used').textContent = sheetsUsed;
            document.getElementById('waste-area').textContent = wasteArea.toLocaleString();
        }
        
        // Export as image
        function exportAsImage() {
            if (cuttingPlan.length === 0) {
                alert(isEnglish ? translations.en['alert-no-plan'] : translations.ar['alert-no-plan']);
                return;
            }
            
            const link = document.createElement('a');
            link.download = isEnglish ? 'cutting_plan.png' : 'Ø®Ø·Ø©_Ø§Ù„Ù‚Ø·Ø¹.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        // Export data
        function exportData() {
            if (cuttingPlan.length === 0) {
                alert(isEnglish ? translations.en['alert-no-plan'] : translations.ar['alert-no-plan']);
                return;
            }
            
            // Create Excel data
            const data = [];
            
            // Add general information
            data.push([isEnglish ? 'Sheet Metal Cutting Plan' : 'Ø®Ø·Ø© Ù‚Ø·Ø¹ Ø§Ù„ØµØ§Ø¬']);
            data.push([isEnglish ? 'Creation Date' : 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', new Date().toLocaleDateString(isEnglish ? 'en-US' : 'ar-EG')]);
            data.push([isEnglish ? 'Sheets Used' : 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©', sheetsUsed]);
            data.push([]);
            
            // Add parts details
            data.push([isEnglish ? 'Parts Details:' : 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø·Ø¹:']);
            data.push([
                isEnglish ? 'Name' : 'Ø§Ù„Ø§Ø³Ù…',
                isEnglish ? 'Quantity' : 'Ø§Ù„Ø¹Ø¯Ø¯',
                isEnglish ? 'Length (mm)' : 'Ø§Ù„Ø·ÙˆÙ„ (Ù…Ù…)',
                isEnglish ? 'Width (mm)' : 'Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ù…)',
                isEnglish ? 'Thickness (mm)' : 'Ø§Ù„Ø³Ù…Ùƒ (Ù…Ù…)'
            ]);
            parts.forEach(part => {
                data.push([part.name, part.quantity, part.length, part.width, part.thickness]);
            });
            
            data.push([]);
            
            // Add cutting plan for each sheet
            cuttingPlan.forEach((sheet, index) => {
                data.push([isEnglish ? `Sheet ${index + 1}:` : `Ø§Ù„Ù„ÙˆØ­ ${index + 1}:`]);
                data.push([
                    isEnglish ? 'Name' : 'Ø§Ù„Ø§Ø³Ù…',
                    isEnglish ? 'Position X' : 'Ø§Ù„Ù…ÙˆØ¶Ø¹ X',
                    isEnglish ? 'Position Y' : 'Ø§Ù„Ù…ÙˆØ¶Ø¹ Y',
                    isEnglish ? 'Rotated' : 'Ù…ØªØ¯ÙˆØ±Ø©'
                ]);
                
                sheet.pieces.forEach(piece => {
                    data.push([
                        piece.name,
                        piece.x,
                        piece.y,
                        piece.rotated ? (isEnglish ? 'Yes' : 'Ù†Ø¹Ù…') : (isEnglish ? 'No' : 'Ù„Ø§')
                    ]);
                });
                
                data.push([]);
            });
            
            // Create workbook
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, isEnglish ? 'Cutting Plan' : 'Ø®Ø·Ø© Ø§Ù„Ù‚Ø·Ø¹');
            
            // Export file
            XLSX.writeFile(wb, isEnglish ? 'cutting_plan.xlsx' : 'Ø®Ø·Ø©_Ø§Ù„Ù‚Ø·Ø¹.xlsx');
        }
        
        // Start the application
        window.onload = initApp;
    </script>
</body>
</html>
